# Backend - template

## Зависимости

* [Docker](https://www.docker.com/).

## Локальная разработка

* Запустите Докер контейнеры:

```bash
docker-compose up --build -d
```

* Сейчас вы можете открыть браузер и вам доступны будут адреса:
(Порт установлен 8888)

Backend: http://localhost/api/
Docs with Swagger U: http://localhost/docs
PGAdmin для подключения к бд: http://localhost:5050/

# Доп. детали по Бэкенду

### Если прям по базе

Все зависимости подтягиваются через pip. 

Файл **start-reload.sh** используется для запуска FastAPI, исключительно для разработки.

Все таблицы создаются путем миграций через alembic.

Добавление SQLModel моделей для данных и таблиц в `./backend/app/models/example-table.py`, endpoints в `./backend/app/api/`, CRUD операции и фукнции в `./backend/app/crud/py`.

### Docker Compose Override

В течении разработки используйте переопределенный docker-compose.override.yml, он специально настроен для разработки. Следовательно при деплое нельзя его испльзовать.


### Скрипты .sh

В проекте написаны bash-скрипты, некоторые автоматически запускаются, а для других надо самому заходить в контейнер и их запускать.

Чтобы войти в контейнер с `bash` сессией надо запустить контейнер:

```console
$ docker compose up -d
```

После `exec` выполнить внутри запущенного контейнера

```console
$ docker compose exec backend bash
```

Вы должны увидеть:

```console
root@7f2607af31c3:/app#
```

Теперь тут вы можете исполнять команды. Например очистить миграции

```console
root@7f2607af31c3:/app# bash /clear_bd.sh
```

Или запустить тесты

```console
root@7f2607af31c3:/app# bash ./scripts/test.sh
```

### Тесты

Тесты запускаются:

```console
$ bash ./scripts/test.sh
```

Тесты используют Pytest, писать свои тесты надо в `./backend/app/tests/`.

Если ваш стэк уже запущен, то используйте

```bash
docker compose exec backend bash /app/tests-start.sh
```
Эта команда сначала проверит базовую работоспособность стека, а затем только перейдет к самим тестам.
Если вы хотите добавить аргументы к команде, то это делается так:

```bash
docker compose exec backend bash /app/tests-start.sh -x
```

### Coverage

Когда тесты выполнятся, в файле `htmlcov/index.html`, который сгенерируется, благодаря coverage, будут вся информация о покрытии тестами вашего кода.

### Миграции

Так как во время локальной разработки ваша директория приложения смонтирована как том внутри контейнера, вы можете также запускать миграции с помощью команд alembic внутри контейнера, и код миграций будет находиться в вашей директории приложения (а не только внутри контейнера). Это позволит вам добавить миграции в ваш git репозиторий.

Убедитесь, что вы создаете "ревизию" ваших моделей и что вы "обновляете" базу данных с этой ревизией каждый раз, когда меняете модели. Это обновит таблицы в вашей базе данных и предотвратит ошибки в приложении.

* Запустите интерактивную сессию в контейнере backend:
```console
$ docker compose exec backend bash
```

* Alembic импортирует ваши SQLModel-и из `./backend/app/models/`.

* После изменения модели (например, добавления столбца), внутри контейнера создайте ревизию, например:
```console
$ alembic revision --autogenerate -m "Add column last_name to User model"
```
или
```console
$ create_migrate "Add column last_name to User model"
```
* После создания ревизии выполните миграцию в базе данных (это фактически изменит базу данных):

```console
$ alembic upgrade head
```

или
```console
$ migrate
```

Если вы хотите начать с модификации или удаления моделей по умолчанию, без предыдущих ревизий, вы можете удалить файлы ревизий (.py файлы) в ./backend/app/alembic/versions/. Затем создайте первую миграцию, как описано выше.